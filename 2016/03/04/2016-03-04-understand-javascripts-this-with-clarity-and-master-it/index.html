<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Erichain"><title>明确并且掌握JavaScript的this · Erichain's Causeries</title><meta name="description" content="翻译自http://javascriptissexy.com/understand-javascripts-this-with-clarity-and-master-it/
JavaScript中的this关键词总是迷惑着新老程序员。本文的目的就是要把关于this的一切全部阐述清楚。读完本文之后，我"><meta name="keywords"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.ico" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/avatar.jpg" style="width:127px;"><h3 title=""><a href="/">Erichain's Causeries</a></h3><div class="description"><p>Everything about Erichain, including blogs, portfolio, projects and life etc.</p></div></div></div><ul class="social-links"><li><a href="http://weibo.com/2246924895"><i class="fa fa-weibo"></i></a></li><li><a href="http://github.com/Erichain"><i class="fa fa-github"></i></a></li></ul><div class="footer"><a target="_blank" href="/"><span>Theme by </span></a><a href="https://www.caicai.me"> CaiCai </a><span>&</span><a href="https://github.com/Ben02/hexo-theme-Anatole"> Ben</a><div class="by_farbox"><a href="https://hexo.io/zh-cn/" target="_blank">Proudly published with Hexo&#65281;</a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="/archives">归档</a></li></div><div class="information"><div class="back_btn"><li><a onclick="window.history.go(-1)" class="fa fa-chevron-left"> </a></li></div><div class="avatar"><img src="/images/avatar.jpg"></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>明确并且掌握JavaScript的this</a></h3></div><div class="post-content"><p>翻译自<a href="http://javascriptissexy.com/understand-javascripts-this-with-clarity-and-master-it/" target="_blank" rel="external">http://javascriptissexy.com/understand-javascripts-this-with-clarity-and-master-it/</a></p>
<p>JavaScript中的<code>this</code>关键词总是迷惑着新老程序员。本文的目的就是要把关于<code>this</code>的一切全部阐述清楚。读完本文之后，我们绝对不用再担心JavaScript中的<code>this</code>部分的知识了。我们会理解如何在各式各样的环境中正确的使用<code>this</code>，包括那些难以实现的棘手的环境。</p>
<p>我们使用 <code>this</code>的方式与我们在自然语言(比如英语或者法语)中使用代词的方式类似。我们会这样写一句话：“John is running fast because he is trying to catch the train.”。注意代词<code>he</code>的用法。我们完全可以这样写：“John is running fast because John is trying to catch the train.”。但是，我们不用重复的再使用一遍<code>John</code>，如果真这样的话，我们的家庭，朋友，同事啥的都会嫌弃我们的。好吧，也许你的家庭不会嫌弃你，但是那些陪你共患难的朋友同事可就不一定咯。在JavaScript中，我们也以这样的方式，把<code>this</code>作为代词或者说引用来使用；就是上下文的主体或者要执行的代码的主体。看下面这个例子：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> person = &#123;</div><div class="line">    <span class="attr">firstName</span>: <span class="string">'Penelope'</span>,</div><div class="line">    <span class="attr">lastName</span>: <span class="string">'Barrymore'</span>,</div><div class="line">    <span class="attr">fullName</span>: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line"></div><div class="line">        <span class="comment">/* 注意到我们在这里使用this就像前面使用he那样了吗？ */</span></div><div class="line">        <span class="built_in">console</span>.log(<span class="keyword">this</span>.firstName + <span class="string">' '</span> + <span class="keyword">this</span>.lastName);</div><div class="line"></div><div class="line">        <span class="comment">// 我们也可以这样写</span></div><div class="line">        <span class="built_in">console</span>.log(person.firstName + <span class="string">' '</span> + person.lastName);</div><div class="line">    &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>如果我们在上面这个例子中使用<code>person.firstName</code>和<code>person.lastName</code>，那么，这段代码就会有歧义了。想象一下，代码中可能有另外的一个叫做<code>person</code>的全局变量(我们可能知道也可能不知道)，那么，对<code>person.firstName</code>的引用就可能是全局变量里的那个<code>person</code>，这样，就会导致很难调试的错误。所以我们使用<code>this</code>，并不只是为了看起来好看，而是为了明确代码的意义，让我们的代码看起来不那么含糊不清。就跟在之前的英语句子里使用代词<code>he</code>让句子结构更清晰一样。他能告诉我们我们引用的是句子开始的那个<code>John</code>。</p>
<p>与使用<code>he</code>来代指前面的主语一样，JavaScript中的<code>this</code>也是用来引用函数所绑定的对象的。<code>this</code>关键词不仅仅引用了对象，还存储了这个对象的值。和代词一样，<code>this</code>可以作为上下文中的对象的简称。关于上下文，后面会讲到。</p>
<hr>
<h3 id="JavaScript中的this基础知识"><a href="#JavaScript中的this基础知识" class="headerlink" title="JavaScript中的this基础知识"></a>JavaScript中的<code>this</code>基础知识</h3><p>首先要知道，JavaScript 中的所有函数都和对象一样都有属性。当函数执行的时候，他就获得了<code>this</code>这个属性——就是一个保存对象的值的变量，而这个对象正好调用了包含<code>this</code>的函数。</p>
<p><code>this</code>总是引用并且保存一个单一对象的值，虽然它可以在全局作用域中使用，但是一般情况下都在函数或者方法体内使用。注意，当我们使用严格模式的时候，在全局函数中，<code>this</code>的值为<code>undefined</code>，在匿名函数中，他不会绑定任何的值。</p>
<p><code>this</code>在函数(比如函数A)内部使用，并且保存了调用那个函数的对象的值。我们需要<code>this</code>来访问调用函数A的对象的属性和方法，尤其是当我们不知道这个对象的名称的时候，而且，有时候，也没有可用的名称来引用这个对象。事实上，<code>this</code>就是正在使用的对象的一个简称。</p>
<p>反复看看下面这个说明<code>this</code>用法的例子：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> person = &#123;</div><div class="line">    <span class="attr">firstName</span>: <span class="string">'Penelope'</span>,</div><div class="line">    <span class="attr">lastName</span>: <span class="string">'Barrymore'</span>,</div><div class="line"></div><div class="line">    <span class="comment">/* this是在showFullName里面使用的，而showFullName又是在person里面定义的，所以，person对象调用showFullName的时候，this就保存了person对象的值 */</span></div><div class="line">    showFullName: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">        <span class="built_in">console</span>.log(<span class="keyword">this</span>.firstName + <span class="string">' '</span> + <span class="keyword">this</span>.lastName);</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">person.showFullName(); <span class="comment">// Penelope Barrymore</span></div></pre></td></tr></table></figure>
<p>再看看<code>this</code>在jQuery中的基本的用法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$(<span class="string">'button'</span>).click(<span class="function"><span class="keyword">function</span> (<span class="params"> event </span>) </span>&#123;</div><div class="line">    <span class="comment">// $(this) 将会保存按钮对象 ($('button')) 的值</span></div><div class="line">    ​<span class="comment">// 因为按钮对象调用了click()函数</span></div><div class="line">    <span class="built_in">console</span>.log($(<span class="keyword">this</span>).prop(<span class="string">'name'</span>));</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>我先解释jQuery的这个例子：<code>$(this)</code>的用法是jQuery中使用<code>this</code>的语法。<code>$(this)</code>在匿名函数中使用，而这个匿名函数，又会在<code>click()</code>函数中执行。<code>$(this)</code>被绑定到了按钮对象的原因就是因为jQuery会把<code>$(this)</code>绑定到调用<code>clcik()</code>函数的对象上。因此，虽然<code>$(this)</code>是定义在一个匿名函数中，他自己不能访问外部函数的<code>this</code>变量，但是<code>$(this)</code>还是会保存<code>$(&#39;button&#39;)</code>对象的值。</p>
<p>注意按钮是HTML中的一个元素，同时也是一个对象。在这个例子中，因为他被包含在了<code>$()</code>中，所以它是一个jQuery对象。</p>
<hr>
<h3 id="this的最大要点"><a href="#this的最大要点" class="headerlink" title="this的最大要点"></a><code>this</code>的最大要点</h3><p>如果你理解关于<code>this</code>的这条定律，那么，对于<code>this</code>这个关键词，你就会很明了了。在对象调用包含<code>this</code>定义的那个函数的时候，<code>this</code>的值才被指定。我们把这个定义<code>this</code>的这个函数叫做<code>this Function</code>。</p>
<p>很明显，虽然<code>this</code>引用了定义它的这个对象，但是并不是直到对象调用函数的时候<code>this</code>才被赋值。它的赋值仅仅是基于调用那个函数(<code>this Function</code>)的对象的。在大多数情况下，<code>this</code>保存的是要调用<code>this Function</code>的那个对象的值。但是，也有一些情况下，<code>this</code>没有能够保存那个对象的值。我后面会讲到那些情况。</p>
<hr>
<h3 id="在全局作用域下this的用法"><a href="#在全局作用域下this的用法" class="headerlink" title="在全局作用域下this的用法"></a>在全局作用域下<code>this</code>的用法</h3><p>在浏览器环境下执行代码的时候，所有的全局变量和全局函数都会被定义在<code>window</code>对象下面。因此，当我们在全局作用域下面使用<code>this</code>的时候，他所引用的值就是<code>window</code>对象(当然，肯定是在非严格模式下)。这个<code>window</code>对象也就是整个JavaScript应用或者说整个页面。</p>
<p>比如这个例子：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> firstName = <span class="string">'Peter'</span>,</div><div class="line">    lastName = <span class="string">'Ally'</span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">showFullName</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="comment">/* 在这个函数里面的this保存的是window对象的值，因为showFullName是定义在全局作用域下的，就跟firstName和lastName一样 */</span></div><div class="line">    <span class="built_in">console</span>.log(<span class="keyword">this</span>.firstName + <span class="string">' '</span> + <span class="keyword">this</span>.lastName);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">var</span> person = &#123;</div><div class="line">    <span class="attr">firstName</span>: <span class="string">'Penelope'</span>,</div><div class="line">    <span class="attr">lastName</span>: <span class="string">'Barrymore'</span>,</div><div class="line">    <span class="attr">showFullName</span>: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">        <span class="comment">/* 下面这行代码里面的this引用的是person对象，因为showFullName函数会被person对象调用 */</span></div><div class="line">        <span class="built_in">console</span>.log(<span class="keyword">this</span>.firstName + <span class="string">' '</span> + <span class="keyword">this</span>.lastName);</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">showFullName(); <span class="comment">// Peter Ally​</span></div><div class="line"></div><div class="line"><span class="comment">/* 所有的全局函数和全局变量都定义在window对象下 */</span></div><div class="line"><span class="built_in">window</span>.showFullName(); <span class="comment">// Peter Ally​</span></div><div class="line"></div><div class="line"><span class="comment">/* 在person对象里的showFullName方法里的this依然引用的是person对象 */</span></div><div class="line">person.showFullName(); <span class="comment">// Penelope Barrymore</span></div></pre></td></tr></table></figure>
<hr>
<h3 id="this最令人误解和复杂的时候"><a href="#this最令人误解和复杂的时候" class="headerlink" title="this最令人误解和复杂的时候"></a><code>this</code>最令人误解和复杂的时候</h3><p><code>this</code>最令人费解的时候包括：</p>
<ul>
<li>借用一个使用了<code>this</code>的函数的时候</li>
<li>使用<code>this</code>指定一个方法给变量的时候</li>
<li>使用<code>this</code>的函数座位回调函数的时候</li>
<li>在闭包里面使用<code>this</code>的时候(内部函数)</li>
</ul>
<p>我们会复现每一个情况并且让<code>this</code>在每一个例子中都维持正确的值。</p>
<p><strong>在继续之前，先说一下关于上下文一些知识</strong></p>
<p>在JavaScript中的上下文与在英语句子中的主题类似：“John is the winner who returned the money.”。这个句子中的主语是John，我们可以说这个句子的上下文就是John，因为整个句子的中心都是围绕他的。甚至<code>who</code>这个代词也是指的John。正如我们在句子中使用分号来分隔句子的主题一样，我们也可以通过是用另一个对象来调用函数来把当前的上下文的切换到另一个对象。</p>
<p>类似的，在JavaScript的代码中就是：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> person = &#123;</div><div class="line">    <span class="attr">firstName</span>: <span class="string">'Penelope'</span>,</div><div class="line">    <span class="attr">lastName</span>: <span class="string">'Barrymore'</span>,</div><div class="line">    <span class="attr">showFullName</span>: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">        <span class="comment">/* 当前的上下文 */</span></div><div class="line">        <span class="built_in">console</span>.log(<span class="keyword">this</span>.firstName + <span class="string">' '</span> + <span class="keyword">this</span>.lastName);</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">/* 当调用showFullName的时候, 上下文是person对象. 在showFullName方法里的this引用的是person对象的值 */</span></div><div class="line">person.showFullName(); <span class="comment">//Penelope Barrymore</span></div><div class="line"></div><div class="line"><span class="comment">/* 如果我们使用不同的对象调用showFullName */</span></div><div class="line">​<span class="keyword">var</span> anotherPerson = &#123;</div><div class="line">    <span class="attr">firstName</span>: <span class="string">'Rohit'</span>,</div><div class="line">    <span class="attr">lastName</span>: <span class="string">'Khan'</span></div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">/* 我们可以使用apply方法来明确设置this的值(后面会更多的讲解apply方法) */</span></div><div class="line">person.showFullName.apply(anotherPerson); <span class="comment">//Rohit Khan​</span></div><div class="line"><span class="comment">/* 所以现在的上下文就是anotherPerson. 因为anotherPerson通过apply调用了showFullName方法 */</span></div></pre></td></tr></table></figure>
<p>下面是<code>this</code>变得很复杂的一些情况。这些例子都包含了修复<code>this</code>值错误的方法。</p>
<p><strong>1、当函数作为回调函数的时候</strong></p>
<p>当我们把使用了<code>this</code>的方法作为回调函数传入的时候，事情就变得有点棘手了。例如：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* 我们想要当页面上的按钮点击的时候, 能够使用clickHandler方法 */</span></div><div class="line"><span class="keyword">var</span> user = &#123;</div><div class="line">    <span class="attr">data</span>: [</div><div class="line">        &#123;</div><div class="line">            <span class="attr">name</span>: <span class="string">'T. Woods'</span>, </div><div class="line">            <span class="attr">age</span>: <span class="number">37</span></div><div class="line">        &#125;, &#123;</div><div class="line">            <span class="attr">name</span>: <span class="string">'P. Mickelson'</span>, </div><div class="line">            <span class="attr">age</span>: <span class="number">43</span></div><div class="line">        &#125;</div><div class="line">    ],</div><div class="line">    <span class="attr">clickHandler</span>: <span class="function"><span class="keyword">function</span> (<span class="params"> event </span>) </span>&#123;</div><div class="line">        <span class="keyword">var</span> randomNum = ((<span class="built_in">Math</span>.random() * <span class="number">2</span> | <span class="number">0</span>) + <span class="number">1</span>) - <span class="number">1</span>; <span class="comment">// random number between 0 and 1​</span></div><div class="line">        </div><div class="line">        <span class="comment">/* 下面这行代码将会从数组中随机选择一个人的姓名和年龄进行打印 */</span></div><div class="line">        <span class="built_in">console</span>.log (<span class="keyword">this</span>.data[randomNum].name + <span class="string">' '</span> + <span class="keyword">this</span>.data[randomNum].age);</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">/* 按钮被$符号包含了起来,所以它是一个jQuery对象 */</span></div><div class="line"><span class="comment">/* 之所以会输出undefined是因为在button对象上没有数据属性 */</span></div><div class="line">$(<span class="string">'button'</span>).click(user.clickHandler); <span class="comment">// Cannot read property '0' of undefined</span></div></pre></td></tr></table></figure>
<p>在上面的代码中，由于<code>$(&#39;button&#39;)</code>是他自己的一个对象，我们把<code>user.clickHandler</code>作为回调函数传入了进去，所以，我们应该就知道，在<code>user.clickHandler</code>函数里的<code>this</code>引用的不再是<code>user</code>对象了。现在<code>this</code>引用的值是<code>user.clickHandler</code>所执行的那个对象。调用<code>user.clickHandler</code>的对象是按钮对象，这个函数将在按钮对象的<code>click</code>方法里执行。</p>
<p>注意，尽管我们调用<code>clickHandler</code>函数的时候使用的是<code>user.clickHandler</code>，但是，<code>clickHandler</code>函数自己会在按钮对象的上下文中执行。所以，现在<code>this</code>引用的是<code>$(&#39;button&#39;)</code>对象。</p>
<p>所以，现在很明显的是，什么时候上下文会发生改变：当我们在其他的对象上执行原来定义在对象上的方法的时候，<code>this</code>就不再引用原来所定义的<code>this</code>的对象了，他会引用调用这个函数的那个对象。</p>
<p><strong>解决办法</strong></p>
<p>既然我们确实想要<code>this</code>引用<code>user</code>对象，那么，我们可以使用<code>bind()</code>, <code>apply()</code>, <code>call()</code>方法来指定<code>this</code>的值。</p>
<blockquote>
<p>我写过一篇关于这几个方法的详细的文章，包括如何在复杂的环境中使用他们来设置<code>this</code>的值。与其在这里长篇大论，倒不如推荐你把这篇文章阅读一下，我认为对于专业的JavaScript程序员来说，是有必要的。文章链接：<a href="http://javascriptissexy.com/javascript-apply-call-and-bind-methods-are-essential-for-javascript-professionals/" target="_blank" rel="external">JavaScript’s Apply, Call, and Bind Methods are Essential for JavaScript Professionals</a></p>
</blockquote>
<p>要修复前面例子的问题，我们可以这样使用<code>bind()</code>方法：</p>
<p>原来的代码是这个样子：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$(<span class="string">'button'</span>).click(user.clickHandler);</div></pre></td></tr></table></figure>
<p>使用<code>bind()</code>方法就会是这样：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$(<span class="string">'button'</span>).click(user.clickHandler.bind(user)); <span class="comment">// P. Mickelson 43</span></div></pre></td></tr></table></figure>
<p><strong>2、修复闭包中的<code>this</code>错误</strong></p>
<p>另外一个容易引人误解的地方就是当我们使用闭包的时候。我们需要注意的很重要的一点就是闭包不能通过<code>this</code>这个关键词访问外部函数的<code>this</code>变量。函数的<code>this</code>只能被自身所访问。例如：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> user = &#123;</div><div class="line">    <span class="attr">tournament</span>: <span class="string">'The Masters'</span>,</div><div class="line">    <span class="attr">data</span>: [</div><div class="line">        &#123;</div><div class="line">            <span class="attr">name</span>: <span class="string">'T. Woods'</span>,</div><div class="line">            <span class="attr">age</span>: <span class="number">37</span></div><div class="line">        &#125;, &#123;</div><div class="line">            <span class="attr">name</span>: <span class="string">'P. Mickelson'</span>,</div><div class="line">            <span class="attr">age</span>: <span class="number">43</span></div><div class="line">        &#125;</div><div class="line">    ],</div><div class="line">    <span class="attr">clickHandler</span>: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">        <span class="comment">/* 在这里使用this没什么问题 */</span></div><div class="line">        <span class="keyword">this</span>.data.forEach(<span class="function"><span class="keyword">function</span> (<span class="params"> person </span>) </span>&#123;</div><div class="line">            <span class="comment">/* 但是在匿名函数里面, this的指向就不再是user对象了. 这个内部函数不能访问外部函数的this */</span></div><div class="line">            <span class="built_in">console</span>.log(<span class="string">'What is This referring to? '</span> + <span class="keyword">this</span>); <span class="comment">//[object Window]​</span></div><div class="line"></div><div class="line">            <span class="built_in">console</span>.log(person.name + <span class="string">' is playing at '</span> + <span class="keyword">this</span>.tournament);</div><div class="line">            <span class="comment">// T. Woods is playing at undefined​</span></div><div class="line">            <span class="comment">// P. Mickelson is playing at undefined​</span></div><div class="line">        &#125;)</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">user.clickHandler(); <span class="comment">// What is 'this' referring to? [object Window]</span></div></pre></td></tr></table></figure>
<p><strong>在匿名函数中的<code>this</code>不能访问外部函数中的<code>this</code>，所以，他会被绑定到<code>window</code>对象下。</strong></p>
<blockquote>
<p>(译者加)注意: 嵌套函数，匿名函数，闭包，如果没有明确的对象进行调用，那么，它们的<code>this</code>指向全局对象，在浏览器中，即<code>window</code>。</p>
</blockquote>
<p><strong>解决方案</strong></p>
<p>为了要解决这个问题，我们可以使用一个很普通的方法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> user = &#123;</div><div class="line">    <span class="attr">tournament</span>: <span class="string">'The Masters'</span>,</div><div class="line">    <span class="attr">data</span>: [</div><div class="line">        &#123;</div><div class="line">            <span class="attr">name</span>: <span class="string">'T. Woods'</span>,</div><div class="line">            <span class="attr">age</span>: <span class="number">37</span></div><div class="line">        &#125;, &#123;</div><div class="line">            <span class="attr">name</span>: <span class="string">'P. Mickelson'</span>,</div><div class="line">            <span class="attr">age</span>: <span class="number">43</span></div><div class="line">        &#125;</div><div class="line">    ],</div><div class="line"></div><div class="line">    <span class="attr">clickHandler</span>: <span class="function"><span class="keyword">function</span> (<span class="params"> event </span>) </span>&#123;</div><div class="line">        <span class="comment">/* 使用另外一个变量来存储user对象的this */</span></div><div class="line">        <span class="keyword">var</span> theUserObj = <span class="keyword">this</span>;</div><div class="line">        <span class="keyword">this</span>.data.forEach (<span class="function"><span class="keyword">function</span> (<span class="params"> person </span>) </span>&#123;</div><div class="line">            <span class="built_in">console</span>.log (person.name + <span class="string">' is playing at '</span> + theUserObj.tournament);</div><div class="line">        &#125;)</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">user.clickHandler();</div><div class="line"><span class="comment">// T. Woods is playing at The Masters​</span></div><div class="line"><span class="comment">//  P. Mickelson is playing at The Masters</span></div></pre></td></tr></table></figure>
<p>对于我来说，像下面那样，使用<code>that</code>来命名完全没有任何价值，而且使用起来一点不方便。所以，我会尽量把变量名写成能够描述<code>this</code>所引用的对象的名字，所以，在前面的代码中，就是这样了：<code>var theUserObj = this</code>。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> that = <span class="keyword">this</span>;</div></pre></td></tr></table></figure>
<p><strong>3、修复当把方法赋值给变量的时候的<code>this</code>的错误</strong></p>
<p><code>this</code>值总是被绑定到另一个对象，这与我们想象的就不同了。看看这个例子，如何把一个使用了<code>this</code>的方法赋值给变量。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* 这个data是全局变量 */</span></div><div class="line"><span class="keyword">var</span> data = [</div><div class="line">    &#123;</div><div class="line">        <span class="attr">name</span>:<span class="string">'Samantha'</span>, </div><div class="line">        <span class="attr">age</span>:<span class="number">12</span></div><div class="line">    &#125;, &#123;</div><div class="line">        <span class="attr">name</span>:<span class="string">'Alexis'</span>, </div><div class="line">        <span class="attr">age</span>:<span class="number">14</span></div><div class="line">    &#125;</div><div class="line">];</div><div class="line"></div><div class="line"><span class="keyword">var</span> user = &#123;</div><div class="line">    <span class="comment">/* 这个data是user对象的属性 */</span></div><div class="line">    data: [</div><div class="line">        &#123;</div><div class="line">            <span class="attr">name</span>: <span class="string">'T. Woods'</span>, </div><div class="line">            <span class="attr">age</span>: <span class="number">37</span></div><div class="line">        &#125;, &#123;</div><div class="line">            <span class="attr">name</span>: <span class="string">'P. Mickelson'</span>, </div><div class="line">            <span class="attr">age</span>: <span class="number">43</span></div><div class="line">        &#125;</div><div class="line">    ],</div><div class="line">    <span class="attr">showData</span>: <span class="function"><span class="keyword">function</span> (<span class="params"> event </span>) </span>&#123;</div><div class="line">        <span class="keyword">var</span> randomNum = ((<span class="built_in">Math</span>.random() * <span class="number">2</span> | <span class="number">0</span>) + <span class="number">1</span>) - <span class="number">1</span>; <span class="comment">// random number between 0 and 1​</span></div><div class="line"></div><div class="line">        <span class="built_in">console</span>.log(<span class="keyword">this</span>.data[randomNum].name + <span class="string">' '</span> + <span class="keyword">this</span>.data[randomNum].age);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">/* 把user.showData赋值给变量 */</span></div><div class="line"><span class="keyword">var</span> showUserData = user.showData;</div><div class="line"></div><div class="line"><span class="comment">// When we execute the showUserData function, the values printed to the console are from the global data array, not from the data array in the user object​</span></div><div class="line"><span class="comment">/* 当执行showUserData函数的时候, 打印出来的信息是来自于全局变量data, 而不是user对象的data */</span></div><div class="line">showUserData(); <span class="comment">// Samantha 12</span></div></pre></td></tr></table></figure>
<p><strong>解决方案</strong></p>
<p>我们可以使用<code>bind()</code>来指定<code>this</code>的值</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* 将showData方法绑定到user对象 */</span></div><div class="line"><span class="keyword">var</span> showUserData = user.showData.bind(user);</div><div class="line"></div><div class="line"><span class="comment">/* 现在我们输出的值就是来自于user对象的了 */</span></div><div class="line">showUserData(); <span class="comment">// P. Mickelson 43</span></div></pre></td></tr></table></figure>
<p><strong>4、修复当借用其他对象的方法时<code>this</code>的错误</strong></p>
<p>在JavaScript开发中，借用方法是很普遍的，作为JavaScript程序员，毫无疑问我们会一次又一次的做这个事情。慢慢的，我们就会被这种节约时间的方式所吸引了。要想了解更多的关于借用方法的知识，参考<a href="http://javascriptissexy.com/javascript-apply-call-and-bind-methods-are-essential-for-javascript-professionals/" target="_blank" rel="external">JavaScript’s Apply, Call, and Bind Methods are Essential for JavaScript Professionals</a>。</p>
<p>我们来测试一下这个例子吧：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* 我们有两个对象. 一个对象有avg方法,另一个没有. 所以我们需要借用这个方法 */</span></div><div class="line"><span class="keyword">var</span> gameController = &#123;</div><div class="line">    <span class="attr">scores</span>: [<span class="number">20</span>, <span class="number">34</span>, <span class="number">55</span>, <span class="number">46</span>, <span class="number">77</span>],</div><div class="line">    <span class="attr">avgScore</span>: <span class="literal">null</span>,</div><div class="line">    <span class="attr">players</span>: [</div><div class="line">        &#123;</div><div class="line">            <span class="attr">name</span>: <span class="string">'Tommy'</span>,</div><div class="line">            <span class="attr">playerID</span>: <span class="number">987</span>,</div><div class="line">            <span class="attr">age</span>: <span class="number">23</span></div><div class="line">        &#125;, &#123;</div><div class="line">            <span class="attr">name</span>: <span class="string">'Pau'</span>,</div><div class="line">            <span class="attr">playerID</span>: <span class="number">87</span>,</div><div class="line">            <span class="attr">age</span>: <span class="number">33</span></div><div class="line">        &#125;</div><div class="line">    ]</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">var</span> appController = &#123;</div><div class="line">    <span class="attr">scores</span>: [<span class="number">900</span>, <span class="number">845</span>, <span class="number">809</span>, <span class="number">950</span>],</div><div class="line">    <span class="attr">avgScore</span>: <span class="literal">null</span>,</div><div class="line">    <span class="attr">avg</span>: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;​</div><div class="line">        <span class="keyword">var</span> sumOfScores = <span class="keyword">this</span>.scores.reduce(<span class="function"><span class="keyword">function</span> (<span class="params"> prev, cur, index, array </span>) </span>&#123;</div><div class="line">            <span class="keyword">return</span> prev + cur;</div><div class="line">        &#125;);</div><div class="line"></div><div class="line">        <span class="keyword">this</span>.avgScore = sumOfScores / <span class="keyword">this</span>.scores.length;</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">/* 如果我们运行下面的代码, gameController.avgScore将被设置为appController的scores数组的平均值 */</span></div><div class="line"><span class="comment">/* 不要运行代码, 这只是举例而已. 我们想要的是appController.avgScore为null */</span></div><div class="line">gameController.avgScore = appController.avg();</div></pre></td></tr></table></figure>
<p><code>avg</code>方法的<code>this</code>不会引用<code>gameController</code>对象，他还是会引用<code>appController</code>，因为是<code>appController</code>调用了他。</p>
<p><strong>解决方案</strong></p>
<p>要让<code>this</code>引用 <code>gameController</code>，我们需要使用<code>apply()</code>方法。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* 注意我们使用的是apply方法, 所以第二个参数要是数组 */</span></div><div class="line">appController.avg.apply(gameController, gameController.scores);</div><div class="line"></div><div class="line"><span class="comment">/* avgScore属性被成功设置在了gameController对象上, 尽管我们是从appController对象借用的这个方法 */</span></div><div class="line"><span class="built_in">console</span>.log(gameController.avgScore); <span class="comment">// 46.4​</span></div><div class="line"></div><div class="line"><span class="comment">/* appController.avgScore属性仍然是null.  */</span></div><div class="line"><span class="built_in">console</span>.log(appController.avgScore); <span class="comment">// null</span></div></pre></td></tr></table></figure>
<p><code>gameController</code>对象借用了<code>appController</code>对象的<code>avg</code>方法，由于我们为<code>apply</code>函数传入的第一个参数为<code>gameController</code>，所以，<code>this</code>会被绑定到<code>gameController</code>对象上。<code>apply</code>函数的第一个参数就是用来明确<code>this</code>的指向的。</p>
<hr>
<h3 id="写在最后"><a href="#写在最后" class="headerlink" title="写在最后"></a>写在最后</h3><p>我希望你已经足够了解JavaScript中的<code>this</code>关键字了。现在你又必须要征服的工具(<code>bind()</code>, <code>apply()</code>, <code>call()</code>)。</p>
<p>正如你所学到的，<code>this</code>在下面这些情况中显得有点麻烦：</p>
<ul>
<li>原始上下文的改变，尤其是在回调函数中</li>
<li>当使用不同的对象调用的时候</li>
<li>借用方法的时候</li>
</ul>
<p>但是永远记住，<code>this</code>总是引用调用<code>this Function</code>的那个对象。</p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2016-03-04</span><i class="fa fa-tag"></i><a href="/categories/Front-End/" title="Front-End" class="tag">Front-End </a></div></div></div></div><div class="share"><div class="evernote"><a href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank" class="fa fa-bookmark"></a></div><div class="weibo"><a href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));" class="fa fa-weibo"></a></div><div class="twitter"><a href="http://twitter.com/home?status=,https://erichain.me/2016/03/04/2016-03-04-understand-javascripts-this-with-clarity-and-master-it/,Erichain's Causeries,明确并且掌握JavaScript的this,;" class="fa fa-twitter"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a role="navigation" href="/2016/03/03/2016-03-03-methods-to-clear-float/" title="清除浮动的各种方法和原理" class="btn">上一篇</a></li><li class="next pagbuttons"><a role="navigation" href="/2016/03/09/2016-03-09-javascript-apply-call-and-bind-methods-are-essential-for-javascript-professionals/" title="专业JavaScript程序员必须知道的apply(), call(), bind()方法" class="btn">下一篇</a></li></ul></div></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>